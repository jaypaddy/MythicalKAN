                             
parameters:
- name: imageTag
  type: string
- name: workingDir
  type: string
     

steps:

# Update kustomization.yaml so we have the final manifest
  - task: Bash@3
    displayName: 'Generate Kustomization file'
    inputs:
      targetType: 'inline'
      script: |
          #!/bin/bash
          sed "s/IMAGE_TAG/BUILD-${{ parameters.imageTag }}/g" \
              $(parameters.workingDir).deployment/kustomize/dev/kustomization.template.yaml \
                > $(parameters.workingDir).deployment/kustomize/dev/kustomization.yaml
          cat $(parameters.workingDir).deployment/kustomize/dev/kustomization.yaml

  - task: KubernetesManifest@0
    name: bake
    displayName: Bake K8s manifests from kustomization path
    inputs:
      action: bake
      renderType: kustomize
      kustomizationPath:  $(parameters.workingDir)/deployment/kustomize/dev

  - task: Bash@3
    name: display_bake
    displayName: Display baked Manifest
    inputs:
      targetType: 'inline'
      script: |
        echo "Manifest Bundle: $(bake.manifestsBundle)"
        cat $(bake.manifestsBundle)
        echo "##vso[task.setvariable variable=MANIFESTS_BUNDLE;isOutput=true;issecret=false]$MANIFESTS_BUNDLE"        


