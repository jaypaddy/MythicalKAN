                             
parameters:
- name: imageRepository
  type: string
- name: imageTag
  type: string
- name: workingDir
  type: string
- name: unittest_reportprefix
  type: string
- name: pythonversion
  type: string
- name: azure_connection_name
  type: string
- name: keyvault_name
  type: string
- name: acr_connect_name
  type: string  

steps:

  - task: AzureKeyVault@2
    inputs:
      azureSubscription: ${{ parameters.azure_connection_name }}
      KeyVaultName: ${{ parameters.keyvault_name }}
      SecretsFilter: '*'
      RunAsPreJob: true

  - task: UsePythonVersion@0
    inputs:
      versionSpec: '${{parameters.pythonversion}}'
    displayName: 'Use Python ${{parameters.pythonversion}}'

  - script: |
      python -m pip install --upgrade pip
    displayName: 'pip install upgrade'

  - script: |
      pip install pytest pytest-azurepipelines
      pip install pytest-cov
    displayName: 'install pytest'

 # Action Rules 
  - script: |
      pip install -r requirements.txt
    displayName: 'install requirements.txt'
    workingDirectory: '${{ parameters.workingDir }}/${{ variables.action_rules_project_name }}'

  - task: Docker@2
    displayName: 'Build & Push Action Rules docker image'
    name: dockerBuild
    inputs:
      containerRegistry: ${{ parameters.acr_connect_name }}
      repository: '${{ parameters.imageRepository }}/${{ variables.action_rules_image_name }}'
      command: 'buildAndPush'
      Dockerfile: '${{parameters.workingDir}}/${{ variables.action_rules_project_name }}/Dockerfile'
      tags: ${{ parameters.imageTag }}
